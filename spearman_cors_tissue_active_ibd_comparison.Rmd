---
title: "Spearman correlations for subsets of cohorts"
output: html_notebook
author: Zakhar Krekhno
---

```{r, echo=FALSE, include=FALSE}
library(phyloseq)
library(readxl)
library(reshape2)
library(psych)
library(tidyverse)
theme_set(theme_classic(base_size = 14))
```

Import all the necessary matrices for analysis
```{r import}
files <- list.files(path = here::here("corr_mats/"))
otu_file_list <- str_subset(files,"clr(.)+otu")
tax_file_list <- str_subset(files,"tax")
ms_file_list <- str_subset(files, "ms")
#Import otu counts
otu_list <- map(otu_file_list, 
                    ~read_csv(file = here::here(str_c("corr_mats/",.))))
otu_mat_list <- otu_list %>% 
  map(column_to_rownames, var = "...1") %>% 
  map(as.matrix)
#Import MS data
mq_mat <- read_csv(file = here::here(str_c("corr_mats/",ms_file_list))) %>% 
  column_to_rownames(var = "...1") %>% 
  as.matrix()
```
Import the metadata and create sub-divided matrices.
We will be doing correlations within just Ileum or Colon and within noIBD, active, or inactive IBD
```{r import-meta}
meta_full <- read_excel(here::here("Metadata.xlsx")) %>% 
  select("sample" = `#SampleID`, "group" = Group, everything()) %>% 
  mutate(sample = str_remove(sample, "Rep")) %>% 
  filter(sample %in% rownames(mq_mat)) %>% 
  mutate(across(matches("(Active)|(TI_resection)|(Cholestyramine)"), ~as.character(fct_recode(as_factor(.x), 
                                                Yes = "1", No = "0", Not_applicable = "NA"))))
#Prepare metadata tables
meta_list_starter <- map(vector(mode = "list", length = 6), ~ meta_full)
meta_list <-meta_list_starter %>% 
  map2(rep(c("Colon","Ileum"), each = 3), 
       ~filter(.x, Tissue_type == .y)) %>% 
  map2(rep(c("Not_applicable","No","Yes"),times = 2), 
       ~filter(.x, Active_IBD == .y))
#Name the list for convenience
subgroups <- str_c(rep(c("Colon","Ileum"), each = 3),rep(c("Not_applicable","No","Yes"),times = 2), sep = "_")
names(meta_list) <- subgroups
```

Make appropriate matrices for each group
```{r subset_mq}
mq_list <- map(vector(mode = "list", length = 6*3), ~ mq_mat) %>% 
  map2(rep(meta_list, each=3), ~ .x [rownames(.x) %in% pull(.y,var = sample),])
otu_filt_list <- rep(otu_mat_list, times = 6) %>% 
  map2(rep(meta_list, each=3), ~ .x [rownames(.x) %in% pull(.y,var = sample),])
```

Run correlations 

```{r spearman, warning=FALSE}
spear_BH_list <- map2(mq_list,otu_filt_list,
                     ~corr.test(x = .x, y = .y, use = "pairwise", method="spearman", adjust="BH", ci=FALSE))
coef_list <- map2(rep(spear_BH_list,each=3),rep(c("r","p","p.adj"),times = 18), ~melt(.x [.y]))

rs_list <- coef_list [seq(from = 1, to = length(coef_list), by = 3)]
ps_list <- coef_list [seq(from = 2, to = length(coef_list), by = 3)]
padj_list <- coef_list [seq(from = 3, to = length(coef_list), by = 3)]

df_list <- pmap(list(rs_list,ps_list,padj_list),
               ~reduce(list(..1,..2,..3),left_join, by = c("Var1","Var2")))
dfs_names <- str_c(rep(c("Family","Genus", "Species"), times = 6),rep(subgroups,each = 3), sep = "_")
names(df_list) <- dfs_names
#walk2(df_list, dfs_names,
 #     ~write_csv(.x,here::here(str_c("spear_results_subset/",.y,"_cor.csv"))))
```

Finish with some filtering of results for ease of work
```{r spearman-plot}
#Filter the results to only include somewhat meaningful work
df_filt_list <- df_list %>% 
  map(~filter(., value < 0.6))
#walk2(df_filt_list, dfs_names,
 #     ~write_csv(.x,here::here(str_c("spear_results/filtered",.y,"_cor.csv"))))

```
